{"device":"PHONE","widgets":{"cardSortDrop":{"t":"Dropdown","lX":5,"lY":15,"sX":5.32,"sY":1,"s":"Traps Phone","ps":{"enabled":"true","scalingType":"NOVERT","width":"50% - 20px","height":"5.66%","x":"5px","y":"15px"},"ver":"190104c190915","dis":false,"tt":"","a":{"label text":"Sort","bold":"true","default options":"trapper,trap type,state,set time","default value":"state","color":"black"},"ev":{"clientEvents":{"outputEvents":{"sort":{"channel":"sortText/receive value","event":"selected","trigger":"selected","important":"false"}}}}},"userFilterDrop":{"t":"Dropdown","lX":1197,"lY":15,"sX":5.32,"sY":1,"s":"Traps Phone","ps":{"enabled":"true","scalingType":"NOVERT","width":"50% - 20px","height":"4.02%","x":"50% + 5px","y":"15px"},"ver":"190104c190915","dis":false,"tt":"","a":{"bold":"true","label text":"User Filter","default options":"","color":"black"},"ev":{"clientEvents":{"inputEvents":{"set Trappers":{"channel":"setFilter/append list","event":"append list","important":"false"},"Set Filter":{"channel":"setFilterSelect/receive value","event":"receive value","important":"false"}},"outputEvents":{"Fire Selected":{"channel":"filterCards/receive value","event":"selected","trigger":"selected","important":"false"}}}}},"trapCardDesktop":{"t":"Trap","lX":0,"lY":70,"sX":11.03,"sY":11.73,"s":"Traps Phone","ps":{"enabled":"true","scalingType":"OK","width":"100%","height":"100% - 70px","x":"0px","y":"70px"},"ver":"190104c190915","z":"100","dis":false,"tt":"","a":{"wait for filter":"true"},"ev":{"clientEvents":{"inputEvents":{"Set animals":{"channel":"setAnimals/set animals","event":"set animals","important":"false"},"Set Trappers":{"channel":"setTrappers/set trappers","event":"set trappers","important":"false"},"Pin pressed":{"channel":"pin pressed/toggle card","event":"toggle card","important":"false"},"Set Trap Types":{"channel":"setTrapTypes/set trap type","event":"set trap type","important":"false"},"Sort":{"channel":"sortCards/sort","event":"sort","important":"false"},"Receive db info":{"channel":"cardDb/receive value","event":"receive value","important":"false"},"filter":{"channel":"filterCards/filter by trappers","event":"filter by trappers","important":"false"},"Receive sensorColl":{"channel":"cardInfo/receive value","event":"receive value","important":"true"},"nicknames":{"channel":"cardNicknames/receive value","event":"receive value","important":"false"},"default trapper":{"channel":"defaultTrapper/set default trapper","event":"set default trapper","important":"false"},"remove card":{"channel":"remove-card/remove card","event":"remove card","important":"false"},"toggle card":{"channel":"toggleCard/toggle card","event":"toggle card","important":"false"},"New Photo":{"channel":"newPhoto/set new photo status","event":"set new photo status","important":"false"}},"outputEvents":{"Clear Trap":{"channel":"clearTrap/receive value","event":"clear trap","trigger":"clear trap","important":"false"},"deactivate trap":{"channel":"clearTrap/receive value","event":"deactivate trap","trigger":"deactivate trap","important":"false"},"Check trap":{"channel":"checkTrap/receive value","event":"check trap","trigger":"check trap","important":"false"},"Trap Set":{"channel":"trapSet/receive value","event":"set trap","trigger":"set trap","important":"false"},"card closed":{"channel":"cardClosed/receive value","event":"card closed","trigger":"card closed","important":"false"},"Address Pressed":{"channel":"addressPressed/receive value","event":"address pressed","trigger":"address pressed","important":"false"},"card opened":{"channel":"cardSelected/receive value","event":"card selected","trigger":"card selected","important":"false"},"plus icon pressed":{"channel":"new virtual trap/receive value","event":"plus icon pressed","trigger":"plus icon pressed","important":"false"},"Camera Pressed":{"channel":"cameraPressed/receive value","event":"photo icon pressed","trigger":"photo icon pressed","important":"false"}}}}},"cardScriptEngineDesktop":{"t":"Scripting","lX":440,"lY":180,"sX":1,"sY":1,"s":"Traps Phone","ps":{"enabled":"false","scalingType":"OK","width":"9.07%","height":"8.05%","x":"39.8%","y":"14.48%"},"ver":"200124c190915","vis":false,"dis":false,"tt":"","a":{"script type":"javascript","code editor":"","import file":"true","file name":"cardScriptEngine.js","subscribe to directory":"true","subscribe to database":"true"},"ev":{"serverEvents":{"inputEvents":{"File Response":{"channel":"$SYS/FILES/RESPONSE/+","event":"feed","important":"false"},"ATS Data":{"channel":"[accountid]/ats/+/+","event":"feed","important":"false"},"Broadcast":{"channel":"$APP/[accountid]/ATS/BROADCAST","event":"feed","important":"false"},"Yabby Data":{"channel":"[accountid]/yabby/+/+","event":"feed","important":"false"},"Devices":{"channel":"$DEV/ADMIN/GETNICKNAMES/RESPONSE","event":"feed","important":"false"},"Trail Camera Data":{"channel":"[accountid]/trail4g/+/+","event":"feed","important":"false"},"Virtual":{"channel":"[accountid]/VTRAP/+/+","event":"feed","important":"false"}}}}},"Maps#0":{"t":"Maps","lX":0,"lY":0,"sX":2.21,"sY":2.49,"s":"Map","ps":{"enabled":true,"scalingType":"OK","width":"100%","height":"100%","x":"0px","y":"0px"},"ver":"190104c190915","dis":false,"tt":"","a":{"zoom":"17"},"ev":{"clientEvents":{"inputEvents":{"plot pins":{"channel":"mapPins/add custom popup","event":"add custom popup","important":"false"},"Set map":{"channel":"setMap/set map","event":"set map","important":"false"},"remove":{"channel":"remove pin/remove custom popup","event":"remove custom popup","important":"false"}}}}},"Button#0":{"t":"Button","lX":20,"lY":1173,"sX":1.2,"sY":1.09,"s":"Map","ps":{"enabled":true,"scalingType":"OK","width":"120px","height":"50px","x":"20px","y":"100% - 80px"},"ver":"190104c190915","dis":false,"tt":"","a":{"button name":"Back","color":"orange strong"},"ev":{"clientEvents":{"outputEvents":{"pressed":{"channel":"backPressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"mapScriptMobile":{"t":"Scripting","lX":40,"lY":105,"sX":1,"sY":1,"s":"Map","ps":{"enabled":false,"scalingType":"OK","width":"5.76%","height":"11.31%","x":"2.25%","y":"10.52%"},"ver":"200124c190915","vis":false,"dis":false,"tt":"","a":{"script type":"javascript","code editor":"//# sourceURL=mobile-script.js\n/**\n * Description: \n * Create Author/Date: \n * Modified Author/Date Date: \n * Version: \n */\n\nvar selectedPin;\nvar latAvg = 0;\nvar lngAvg = 0;\nvar count = 0;\nvar mapPins = {};\n\n/**\n * Initialise script state (run once at startup)\n */\nScript.on('load', function() {\n\t\n\tClientEvents.setOptions({\n\t\tpersist:false\n\t});\n\t\n\tClientEvents.subscribe(\"backPressed\", function(data) {\n\t\tClient.jumpToScreen(\"Traps Phone\");\n\t});\n\t\n\tselectedPin = Script.getState(\"currentPin\");\n});\n\t\t  \nScript.on('server', function(data, channel) {\n\t\n\tif (data.sysmeta.label == \"sensacollection\" && typeof data.value == \"string\") {\n\t\tvar collection = SensaCollection.load(JSON.parse(data.value));\n\n\t\tvar mapData = collection.filter(['instance','LAT', 'LON','STATE']);\n\t\t\n\t\tif (mapData.columns.length !== 4) {\n\t\t\tLog.info(\"Data is out of date. Could not locate sensor positions.\");\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tmapData.setColumns(['instance', 'lat', 'lon', 'state']);\n\t\tvar pinTemplate = Script.getScriptElement(\"pinTemplateMobile\");\n\n\t\tmapData.forEach(function(result, key) {\n\t\t\tvar pinContent = pinTemplate.cloneNode(true);\n\t\t\tpinContent.querySelector(\"[data-value='title']\").innerHTML = key;\n\t\t\tpinContent.querySelector(\"[data-value='id']\").innerHTML = key;\n\n\t\t\tif (selectedPin && selectedPin.toLowerCase() == key.toLowerCase()) {\n\t\t\t\tpinContent.classList.add(\"pinSelected\");\n\t\t\t\tClientEvents.publish(\"setMap\", {\n\t\t\t\t\tlat: parseFloat(result.lat),\n\t\t\t\t\tlng: parseFloat(result.lon)\n\t\t\t\t});\t\t\t\n\t\t\t}\n\n\t\t\t// Set pin state.\n\t\t\tvar state = +result.state;\n\t\t\tif (state && state == 1) {\n\t\t\t\tif (channel.split(\"/\")[1].toLowerCase() === \"virtual\") {\n\t\t\t\t\tpinContent.querySelector(\"[data-value='icon']\").classList.add(\"virtual\");\n\t\t\t\t}\n\t\t\t\tpinContent.querySelector(\"[data-value='icon']\").classList.add(\"greenIcon\");\n\t\t\t} else if (state && state == 2) {\n\t\t\t\tpinContent.querySelector(\"[data-value='icon']\").classList.add(\"redIcon\");\n\t\t\t}\n\n\t\t\tvar pin = {\n\t\t\t\tid: key,\n\t\t\t\tcontent: pinContent,\n\t\t\t\tloc: {\n\t\t\t\t\tlat: parseFloat(result.lat),\n\t\t\t\t\tlng: parseFloat(result.lon)\n\t\t\t\t}\n\t\t\t};\n\t\t\t\n\t\t\tmapPins[key.toLowerCase()] = pin;\n\t\t\t\n\t\t\tif (typeof state !== \"undefined\" && state == 0) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Send pin to map.\n\t\t\tClientEvents.publish(\"mapPins\", pin, false);\n\n\t\t\tlatAvg += pin.loc.lat;\n\t\t\tlngAvg += pin.loc.lng;\n\t\t\tcount += 1;\n\t\t});\n\n\t\tif (selectedPin == null) {\n\t\t\tClientEvents.publish(\"setMap\", {\n\t\t\t\tlat: latAvg / count,\n\t\t\t\tlng: lngAvg / count\n\t\t\t});\n\t\t}\n\t} else {\n\t\t// Get channel id\n\t\tvar fqn = data.sysmeta.channel.split(\"/\");\n\t\tvar id = fqn[2];\n\t\tvar scope = fqn[3].toLowerCase();\n\t\t\n\t\tif (scope === \"state\" && data.value == 2) {\n\t\t\tClient.notify(\"Trapper Triggered\", {\n\t\t\t\tbody: id + \" was triggered.\",\n\t\t\t\ticon: \"/userfiles/Animal-Trap-Icon-Red.png\"\n\t\t\t});\n\t\t\tif (mapPins[id.toLowerCase()] !== undefined) {\n\t\t\t\tmapPins[id.toLowerCase()].content.querySelector(\"[data-value='icon']\").classList = [];\n\t\t\t\tmapPins[id.toLowerCase()].content.querySelector(\"[data-value='icon']\").classList.add('redIcon');\n\t\t\t\tmapPins[id.toLowerCase()].content.style.setProperty(\"display\", \"\");\n\t\t\t\t// Send pin to map.\n\t\t\t\tClientEvents.publish(\"mapPins\", mapPins[id.toLowerCase()], false);\n\t\t\t}\n\t\t} else\tif (scope === \"state\" && data.value == 1) {\n\t\t\tif (mapPins[id.toLowerCase()] !== undefined) {\n\t\t\t\tmapPins[id.toLowerCase()].content.querySelector(\"[data-value='icon']\").classList = [];\n\t\t\t\tmapPins[id.toLowerCase()].content.querySelector(\"[data-value='icon']\").classList.add('greenIcon');\n\t\t\t\tmapPins[id.toLowerCase()].content.style.setProperty(\"display\", \"\");\n\t\t\t\t// Send pin to map.\n\t\t\t\tClientEvents.publish(\"mapPins\", mapPins[id.toLowerCase()], false);\n\t\t\t}\n\t\t} else if (scope === \"state\" && data.value == 0) {\n\t\t\tif (mapPins[id.toLowerCase()] !== undefined) {\n\t\t\t\tmapPins[id.toLowerCase()].content.querySelector(\"[data-value='icon']\").classList = [];\n\t\t\t\tmapPins[id.toLowerCase()].content.querySelector(\"[data-value='icon']\").classList.add('redIcon');\n\t\t\t\tClientEvents.publish(\"remove pin\", id, false);\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (scope === \"lat\") {\n\t\t\t\t// Get pin and update location\n\t\t\t\tvar pin = mapPins[id.toLowerCase()];\n\n\t\t\t\tif (pin !== undefined) {\n\t\t\t\t\tpin.loc.lat = parseFloat(data.value);\n\t\t\t\t\tClientEvents.publish(\"mapPins\", pin);\n\t\t\t\t\tmapPins[id] = pin;\n\t\t\t\t}\n\t\t\t} else if (scope === \"lon\") {\n\t\t\t\t// Get pin and update location\n\t\t\t\tvar pin = mapPins[id.toLowerCase()];\n\n\t\t\t\tif (pin !== undefined) {\n\t\t\t\t\tpin.loc.lng = parseFloat(data.value);\n\t\t\t\t\tClientEvents.publish(\"mapPins\", pin);\n\t\t\t\t\tmapPins[id] = pin;\n\t\t\t\t}\n\t\t\t}\n\t}\n});"},"ev":{"serverEvents":{"inputEvents":{"Yabby":{"channel":"[accountid]/yabby/+/+","event":"feed","important":"false"},"ATS":{"channel":"[accountid]/ATS/+/+","event":"feed","important":"false"},"Virtual":{"channel":"[accountid]/virtual/+/+","event":"feed","important":"false"},"trailcam":{"channel":"[accountid]/trail4g/+/+","event":"feed","important":"false"}}}}},"pinTemplateMobile":{"t":"Scripting","lX":200,"lY":100,"sX":1,"sY":1,"s":"Map","ps":{"enabled":false,"scalingType":"NOSCALE","width":"","height":"","x":"","y":""},"ver":"200124c190915","vis":false,"dis":false,"tt":"","a":{"script type":"html","code editor":"<div>\n<style>\n   /* Triggered */\n  .redIcon {\n     background-image: url(\"/userfiles/Animal-Trap-Icon-Red.svg\");\n     background-size: contain;\n     background-color: white;\n     border-radius: 5px;\n  }\n      \n  /* Inactive */\n  .greyIcon {\n    background-image: url(\"/userfiles/Animal-Trap-Icon-DkGrey.svg\");\n    background-size: contain;\n    background-color: white;\n    border-radius: 5px;\n   }\n        \n   /* Set  */\n   .greenIcon {\n     background-image: url(\"/userfiles/Animal-Trap-Icon-Green_2.svg\");\n     background-size: contain;\n     background-color: white;\n     border-radius: 5px;\n   }\n\t.virtual.greenIcon {\n\t\tbackground-image: url(\"/userfiles/Virtual_Trap_Icon_Green.svg\")\n    }\n    \n    .pinSelected {\n       background-color: black;   \n    }\n    \n    .main {\n      background-color: rgba(128, 128, 128, 0.7);\n      color: white;\n      border: 2px solid black;\n      border-radius: 4px;\n      padding: 4px;\n      overflow: hidden;\n      min-width: 140px;\n    }\n\n    .title {\n      font-size: large;\n    }\n\n    .name {\n      float: right;\n    }\n    \n    .container {\n      height: 30px;\n      position: relative; \n    }\n        \n    .vertical-center {\n      margin: 0;\n      position: absolute;\n      top: 50%;\n      -ms-transform: translateY(-50%);\n      transform: translateY(-50%);\n    }\n\n</style>\n<div class=\"main pinSelected\"  onclick=\"fw.fireEvent('custom popup pressed', this.querySelector('[data-value=\\'id\\']').innerHTML);\">\n  <div class=\"container\">\n\t<div data-value=\"id\" style=\"display: none;\">--</div>\n    <div data-value=\"icon\" class=\"redIcon\" style=\"display: inline-block; width: 25px; height: 25px; margin-right: 4px;\"></div>\n    <div data-value=\"title\" class=\"title vertical-center\" style=\"display: inline-block; left: 30px;\">\n      --\n    </div>\n  </div>\n</div>\n</div>"},"ev":{}},"Image#0":{"t":"Image","lX":0,"lY":370,"sX":17.43,"sY":4.42,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"","width":"100%","height":"50%","x":"0%","y":"30% + 110px"},"ver":"202605c190915","dis":false,"tt":"","a":{"border width":"","3D shadow":"true","background":"grey","image":""},"ev":{"clientEvents":{"inputEvents":{"Set Image":{"channel":"iamge-set/set image","event":"set image","important":"false"}}}}},"Carousel#0":{"t":"Carousel","lX":0,"lY":197,"sX":17.43,"sY":2.2,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"100%","height":"24.89%","x":"0px","y":"110px + 5%"},"ver":"190104c190915","dis":false,"tt":"","a":{"per page":"3","focus border":"orange"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"thumb-receive/receive value","event":"receive value","important":"false"},"Clear":{"channel":"thumb-clear/clear","event":"clear","important":"false"},"Next":{"channel":"thumb-next/next","event":"next","important":"false"},"goTo":{"channel":"thumb-goTo/goTo","event":"goTo","important":"false"},"Previous":{"channel":"thumb-previous/previous","event":"previous","important":"false"},"Remove":{"channel":"thumb-remove/remove slide","event":"remove slide","important":"false"}},"outputEvents":{"Pressed":{"channel":"thumb-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"},"Changed":{"channel":"thumb-changed/receive value","event":"onChange","trigger":"onChange","important":"false"}}}}},"Container#0":{"t":"Container","lX":0,"lY":684,"sX":17.43,"sY":5.27,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"100%","height":"59.58%","x":"0%","y":"105%"},"ver":"190104c190915","z":"110","dis":false,"tt":"","a":{"title":"Photo Information","color":"grey"},"ev":{}},"Label#0":{"t":"Label","lX":35,"lY":1431,"sX":6.15,"sY":1.76,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"35.28%","height":"4.98%","x":"2%","y":"115%"},"ver":"200124c190915","dis":false,"tt":"","a":{"font size":"14","label text":"<b>Time: </b>[#]"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"time-receive/receive value","event":"receive value","important":"false"}}}}},"Icon#0":{"t":"Icon","lX":0,"lY":470,"sX":0.1,"sY":0.1,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"5px","height":"9.25%","x":"0%","y":"100% - 10px"},"ver":"200628c190915","dis":false,"tt":"","a":{"icon file":"chevron-compact-left","outline color":"no outline","color":"orange strong","hover":"orange"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"previous-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#1":{"t":"Icon","lX":700,"lY":465,"sX":0.1,"sY":0.1,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"5px","height":"9.25%","x":"51.01%","y":"5px"},"ver":"200628c190915","dis":false,"tt":"","a":{"icon file":"chevron-compact-right","outline color":"no outline","color":"orange strong","hover":"orange"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"next-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#3":{"t":"Icon","lX":1174,"lY":107,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"68%","y":"20px + 5%"},"ver":"200628c190915","dis":false,"tt":"Archive","a":{"icon file":"archive","outline color":"no outline","color":"black"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"archive-receive/receive value","event":"receive value","important":"false"}},"outputEvents":{"Pressed":{"channel":"archive-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#4":{"t":"Icon","lX":1553,"lY":107,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"90%","y":"20px + 5%"},"ver":"200628c190915","dis":false,"tt":"Delete","a":{"icon file":"trash","outline color":"no outline","color":"red"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"delete-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#5":{"t":"Icon","lX":984,"lY":107,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"57%","y":"20px + 5%"},"ver":"200628c190915","dis":false,"tt":"Favourite","a":{"icon file":"star","outline color":"no outline","color":"black"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"favourite-receive/receive value","event":"receive value","important":"false"}},"outputEvents":{"Pressed":{"channel":"favourite-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#2":{"t":"Icon","lX":1415,"lY":1734,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"82%","y":"150%"},"ver":"200628c190915","dis":false,"tt":"save","a":{"outline color":"no outline"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"save-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#7":{"t":"Icon","lX":1553,"lY":1734,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"90%","y":"150%"},"ver":"200628c190915","dis":false,"tt":"clear","a":{"outline color":"no outline","icon file":"x"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"clear-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Icon#8":{"t":"Icon","lX":1364,"lY":107,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"79%","y":"20px + 5%"},"ver":"200628c190915","dis":false,"tt":"Download","a":{"icon file":"download","outline color":"no outline","color":"black"},"ev":{"clientEvents":{"inputEvents":{},"outputEvents":{"Pressed":{"channel":"download-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"image-tags":{"t":"Input","lX":35,"lY":1561,"sX":13.94,"sY":1,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOVERT","width":"80%","height":"6%","x":"2%","y":"130%"},"ver":"270520c190915","dis":false,"tt":"","a":{"label text":"Tags","bold":"true","form id":"image-tagging","color":"grey"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"tags-receive/receive value","event":"receive value","important":"false"}}}}},"image-comments":{"t":"Text Area","lX":35,"lY":1691,"sX":13.94,"sY":1.76,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"80%","height":"19.91%","x":"2%","y":"145%"},"ver":"190104c190915","dis":false,"tt":"","a":{"bold":"true","label text":"Comments","form id":"image-tagging","color":"grey"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"comments-receive/receive value","event":"receive value","important":"false"}}}}},"Label#2":{"t":"Label","lX":35,"lY":915,"sX":6.45,"sY":1,"s":"Image Viewer","ps":{"enabled":"false","scalingType":"OK","width":"44.12%","height":"2.89%","x":"2.74%","y":"73.62%"},"ver":"200124c190915","z":"110","vis":false,"dis":false,"tt":"","a":{"font size":"14","label text":"<b>Address:&nbsp;</b>[#]"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"address-receive/receive value","event":"receive value","important":"false"}}}}},"Input#0":{"t":"Input","lX":0,"lY":59,"sX":4.01,"sY":1,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOVERT","width":"23%","height":"4.41%","x":"0px","y":"6%"},"ver":"270520c190915","dis":false,"tt":"","a":{"type":"number","default value":"1","color":"grey"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"file-index-receive/receive value","event":"receive value","important":"false"}},"outputEvents":{"On Change":{"channel":"file-index-change/receive value","event":"on change","trigger":"on change","important":"false"}}}}},"Label#3":{"t":"Label","lX":397,"lY":107,"sX":4.01,"sY":1,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"23%","height":"25px","x":"23%","y":"20px + 5%"},"ver":"200124c190915","dis":false,"tt":"","a":{"font size":"14","label text":"<b><font size=\"4\">of [#]</font></b>"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"file-count-receive/receive value","event":"receive value","important":"false"}}}}},"Icon#9":{"t":"Icon","lX":794,"lY":107,"sX":3.49,"sY":3.49,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOHORIZ,NOVERT","width":"10%","height":"19.68%","x":"46%","y":"20px + 5%"},"ver":"200628c190915","dis":false,"tt":"View Video","a":{"icon file":"camera-video","outline color":"no outline","color":"black"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"video-receive/receive value","event":"receive value","important":"false"}},"outputEvents":{"Pressed":{"channel":"video-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Label#4":{"t":"Label","lX":35,"lY":875,"sX":6.45,"sY":1,"s":"Image Viewer","ps":{"enabled":"false","scalingType":"OK","width":"44.12%","height":"2.89%","x":"2.87%","y":"70.39%"},"ver":"200124c190915","z":"110","vis":false,"dis":false,"tt":"","a":{"font size":"14","label text":"<b>Filename:&nbsp;</b>[#]<b>&nbsp;</b>"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"filename-receive/receive value","event":"receive value","important":"false"}}}}},"Label#5":{"t":"Label","lX":40,"lY":895,"sX":6.45,"sY":1,"s":"Image Viewer","ps":{"enabled":"false","scalingType":"OK","width":"44.12%","height":"2.89%","x":"2.39%","y":"72.33%"},"ver":"200124c190915","z":"110","vis":false,"dis":false,"tt":"","a":{"font size":"14","label text":"<b>Camera Name:&nbsp;</b>[#]<b>&nbsp;</b>"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"camera-name-receive/receive value","event":"receive value","important":"false"}}}}},"Label#6":{"t":"Label","lX":35,"lY":935,"sX":6.45,"sY":1,"s":"Image Viewer","ps":{"enabled":"false","scalingType":"OK","width":"44.12%","height":"2.83%","x":"2.53%","y":"75.73%"},"ver":"200124c190915","z":"110","vis":false,"dis":false,"tt":"","a":{"font size":"14","label text":"<b>Customer:&nbsp;</b>[#]<b>&nbsp;</b>"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"customer-receive/receive value","event":"receive value","important":"false"}}}}},"Dropdown#0":{"t":"Dropdown","lX":0,"lY":142,"sX":17.43,"sY":1,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"NOVERT","width":"100%","height":"5.66%","x":"0px","y":"55px  + 5%"},"ver":"190104c190915","z":"100","dis":false,"tt":"","a":{"bold":"true","label text":"Filter By","default options":"All,Favourite,Archived,Not Viewed","default value":"All"},"ev":{"clientEvents":{"inputEvents":{"Reset":{"channel":"filter-reset/reset default","event":"reset default","important":"false"}},"outputEvents":{"Selected":{"channel":"filter-selected/receive value","event":"selected","trigger":"selected","important":"false"}}}}},"Label#7":{"t":"Label","lX":35,"lY":1474,"sX":6.15,"sY":1.76,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"35.28%","height":"4.98%","x":"2.01%","y":"120%"},"ver":"200124c190915","dis":false,"tt":"","a":{"font size":"14","label text":"<b>Date: </b>[#]<br>"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"date-receive/receive value","event":"receive value","important":"false"}}}}},"Table#1":{"t":"Table","lX":0,"lY":0,"sX":23.83,"sY":12.44,"s":"Camera Table","ps":{"enabled":"true","scalingType":"OK","width":"100%","height":"100%","x":"0%","y":"0%"},"ver":"190104c190915","dis":false,"tt":"","a":{"text color":"#000000","row color":"#000000","columns":"thumbnail,camera name,datetime,viewed,battery,signal","colWidths":"0.167145318782309,0.1665709362435382,0.1665709362435382,0.1665709362435382,0.1665709362435382,0.1665709362435382"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"camera-table-receive/receive value","event":"receive value","important":"false"},"clear":{"channel":"camera-table-clear/delete all rows","event":"delete all rows","important":"false"}},"outputEvents":{"Pressed":{"channel":"camera-table-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Scripting#3":{"t":"Scripting","lX":25,"lY":785,"sX":1,"sY":1,"s":"Image Viewer","ps":{"enabled":"false","scalingType":"NOSCALE","width":"5.74%","height":"11.31%","x":"1.38%","y":"88.91%"},"ver":"200124c190915","vis":false,"dis":false,"tt":"","a":{"script type":"javascript","code editor":"//# sourceURL=dynamic-script.js\n/**\n * Description: \n * Create Author/Date: \n * Modified Author/Date Date: \n * Version: \n */\n\n/******************************************************************\n\t\t\t\tGLOBALS\n******************************************************************/\nvar imageIndex;\nvar carouselIndex = 0;\nvar loaded = [];\nvar currentImage;\nvar camera_images;\nvar carouselPhotos;\nvar camname;\nvar offset = 0;\nvar video = false;\nvar filter = \"ALL\";\n\n/******************************************************************\n\t\t\t\tFUNCTIONS\n******************************************************************/\nfunction create_popup() {\n\tvar el = new Image();\n\tel.src = \"../images/icons/bootstrap/camera-fill.svg\";\n\treturn el;\n}\n\nfunction map_array_to_carousel_obj(arr) {\n\tif (arr.length < 9) {\n\t\tthrow new Error(\"Array too small\");\n\t}\n\tvar asso = (arr.length >= 10 ? arr[9]: \"\");\n\tvar obj = {\n\t\tfilename: arr[0],\n\t\tcamname: arr[1],\n\t\tdatetime: arr[2],\n\t\tviewed: arr[3],\n\t\tfavourite: arr[4],\n\t\tdeleted: arr[5],\n\t\tarchive: arr[6],\n\t\tcomments: arr[7],\n\t\ttags: arr[8],\n\t\tassociated_video: asso,\n\t\tlat: arr[10],\n\t\tlong: arr[11],\n\t\taccount: arr[12]\n\t};\n\treturn obj;\n}\n\nfunction dateChange(eventData, channel) {\n\tvar start = Math.floor( Date.now() / 1000);\n\tvar end = Math.floor(new Date(0).getTime() / 1000 );\n\tvar obj = Script.getForm(\"DateFilter\");\n\tvar startDateArray = obj[\"Date#1\"].split(\"-\");\n\tvar endDateArray = obj[\"Date#2\"].split(\"-\");\n\tif (obj[\"Date#2\"] !== \"\") {\n\t\tend = Math.floor(new Date(endDateArray[0], endDateArray[1] - 1, endDateArray[2], 0).getTime() / 1000);\n\t}\n\tif (obj[\"Date#1\"] !== \"\") {\n\t\tstart = Math.floor(new Date(startDateArray[0], startDateArray[1] - 1, startDateArray[2], 24).getTime() / 1000);\n\t}\n\tvar data = {};\n\tObject.keys(camera_images.data).forEach(function (key, index, array) {\n\t\tvar datetime = camera_images.data[key][2];\n\t\tif (datetime <= start && datetime >= end) {\n\t\t\tdata[key] = camera_images.data[key];\n\t\t}\n\t});\n\tvar value = {\n\t\tdata: data\n\t};\n\tClient.clearDirtyFlag();\n\tpopulate_carousel(value);\n}\n\nfunction get_carousel_images(camname, filter){\n\tClientEvents.publish(\"iamge-set\", \"../images/blank.png\");\n\tif (filter !== undefined) {\n\t\tfilter = \" AND \" + filter;\n\t} else {\n\t\tfilter = \"\";\n\t}\n\tDatabase.readRecords(\n\t\t\"photos\",\n\t\t\"photos\",\n\t\tfunction (dbResponse) {\n\t\t\tcamera_images = dbResponse.value;\n\t\t\tpopulate_carousel(dbResponse.value);\n\t\t},\n\t\t{\n\t\t\tcolumns:\"filename,camname,datetime,viewed,favourite,deleted,archive,comments,tags,associatedvideo,lat,long,account\",\n\t\t\tfilter: \"camname='\"+camname+\"' AND deleted=0 AND account=\" + User.accountid + filter,\n\t\t\torder: \"ORDER BY datetime DESC\"\n\t\t}\n\t);\n}\n\nfunction set_video(obj) {\n\tvar loc = obj.camname.toUpperCase().replace(\" \", \"_\");\n\tif (obj.associated_video === \"\") {\n\t\t var i = parseInt(obj.filename.substr(obj.filename.length - 8, 4));\n\t\t var j = i+2;\n\t\t console.log(i, j);\n\t\t var str = obj.filename.replace(i.toString(), j.toString());\n\t\t ClientEvents.publish(\"iamge-set\", \"../userfiles/photo_processor/\" +  obj.account + \"/\" + loc + \"/\" + str + \".MOV\");\n\t} else {\n\t\tClientEvents.publish(\"iamge-set\", \"../userfiles/photo_processor/\" + obj.account + \"/\" + loc + \"/\" + obj.associated_video);\n\t}\n}\n\nfunction populate_fields(obj) {\n\t// Will need to change this to look in right folder when updating to that build\n\tvar cameraFolder = obj.camname.toUpperCase().replace(\" \", \"_\");\n\tif (obj == undefined) {\n\t\treturn;\n\t}\n\tif (obj.camname == undefined || obj.filename == undefined) {\n\t\treturn;\n\t}\n\tif (video) {\n\t\tset_video(obj);\n\t} else {\n\t\tClientEvents.publish(\"iamge-set\", \"../userfiles/photo_processor/\" + obj.account + \"/\" + cameraFolder + \"/\" +obj.filename + \"-preview.JPG\");\n\t}\n\tClientEvents.publish(\"image-viewer-map-clear\", \"\", false);\n\tvar content = create_popup();\n\tvar loc = {lat: parseFloat(obj.lat), lng: parseFloat(obj.long)};\n\tClientEvents.publish(\"image-viewer-map-receive\", {id: obj.filename, loc: loc, content: content}, false);\n\tClientEvents.publish(\"image-viewer-set-map\", loc);\n\tClientEvents.publish(\"image-viewer-map-set-zoom\", 15);\n\t\n\tset_filename(obj.filename);\n\tvar fav = (obj.favourite === \"1\" ? true : false);\n\tvar arch = (obj.archive === \"1\" ? true : false);\n\t\n\tvar datetime = new Date(parseInt(obj.datetime * 1000)).toLocaleString(\"en-AU\").split(\",\");\n\t\n\tClientEvents.publish(\"time-receive\", datetime[1]);\n\tClientEvents.publish(\"date-receive\", datetime[0]);\n\t//ClientEvents.publish(\"customer-receive\", \"\");\n\t//ClientEvents.publish(\"address-receive\", \"\");\n\tClientEvents.publish(\"camera-name-receive\", obj.camname);\n\n\tset_favourite(fav);\n\tset_archive(arch);\n\tview_image(obj);\n\tset_tags(obj.tags);\n\tset_comments(obj.comments);\n}\n\nfunction populate_carousel(value){\n\tcarouselPhotos = {};\n\tClientEvents.publish(\"thumb-clear\");\n\tloaded = [];\n\t\n\timageIndex = 0;\n\tcarouselIndex = 0;\n\tvar keys = Object.keys(value.data);\n\tvar len = keys.length;\n\tClientEvents.publish(\"file-count-receive\", len);\n\tClientEvents.publish(\"file-index-receive\", 1);\n\tkeys.forEach(function (key, index) {\n\t\t// Add entry to carouselPhotos\n\t\tvar data = map_array_to_carousel_obj(value.data[key]);\n\t\tvar cameraFolder = data.camname.toUpperCase().replace(\" \", \"_\");\n\t\tcarouselPhotos[data.filename] = data;\n\t\t// Send to Image viewer\n\t\tif (index === 0) {\n\t\t\tpopulate_fields(data);\n\t\t}\n\t\t\n\t\tif (index < 10) {\n\t\t\tif (loaded.indexOf(data.filename) === -1) {\n\t\t\t\tloaded.push(data.filename);\n\t\t\t}\n\t\t\tvar packet = {\n\t\t\t\tmethod: \"append\",\n\t\t\t\tsrc: \"../userfiles/photo_processor/\" + data.account + \"/\" + cameraFolder + \"/\" + data.filename + \"-thumb.JPG\",\n\t\t\t\tlabel: new Date(parseInt(data.datetime * 1000)).toLocaleString(\"en-AU\").replace(\",\", \"\"),\n\t\t\t};\n\t\t\tClientEvents.publish(\"thumb-receive\", packet);\n\t\t}\n\t});\n}\n\nfunction view_image(obj) {\n\tvar dbRec = {};\n\tdbRec.filename = obj.filename;\n\tdbRec.camname = obj.camname;\n\tdbRec.customer = \"\";\n\tdbRec.viewed = \"1\";\n\tvar dbReq = {};\n\tdbReq[obj.filename] = dbRec;\n\tDatabase.updateRecord(\"photos\", \"photos\", dbReq, function (dbResponse) {\n\t\tif (dbResponse.value == 0) {\n\t\t\tLog.warn(\"Unable to update the viewed status of image. :(\");\n\t\t}\n\t\tvar options = {\n\t\t\tcategory: User.accountid.toUpperCase(),\n\t\t\tclassName: \"TRAILCAMERA\",\n\t\t\tinstance: obj.camname,\n\t\t\tscope: \"viewed\",\n\t\t\tvalue: \"1\",\n\t\t};\n\t\tScript.publishToChannel(options);\n\t});\n\t//set_viewed(true);\n}\n\nfunction set_filename(name) {\n\tcurrentImage = carouselPhotos[name];\n\tClientEvents.publish(\"filename-receive\", name);\n}\n\nfunction set_favourite(fav) {\n\tif (fav === true) {\n\t\tClientEvents.publish(\"favourite-receive\", \"star-fill\");\n\t\treturn;\n\t}\n\tClientEvents.publish(\"favourite-receive\", \"star\");\n}\n\nfunction favourite_image(img, favourite) {\n\tvar dbRec = {};\n\tdbRec.filename = img;\n\tdbRec.favourite = (favourite === true ? 1 : 0);\n\tdbRec.camname = camname;\n\tdbRec.account = User.accountid;\n\tvar dbReq = {};\n\tdbReq[img] = dbRec;\n\tDatabase.updateRecord(\"photos\", \"photos\", dbReq, function (dbResponse) {\n\t\tvar req = JSON.parse(dbResponse.usrmeta.order);\n\t\tvar key = Object.keys(req)[0];\n\t\tvar entry = req[key];\n\t\tif (dbResponse.value === 0) {\n\t\t\tSystem.status(\"Unable to favourite image '\" + entry.filename + \"'.\");\n\t\t\treturn;\n\t\t}\n\t\tcarouselPhotos[entry.filename].favourite = \"\" + entry.favourite.toString();\n\t\tvar favourite = (entry.favourite === 1 ? true : false);\n\t\tset_favourite(favourite);\n\t});\n}\n\nfunction set_archive(archived) {\n\tif (archived === true) {\n\t\tClientEvents.publish(\"archive-receive\", \"archive-fill\");\n\t\treturn;\n\t}\n\tClientEvents.publish(\"archive-receive\", \"archive\");\n}\n\nfunction archive_image(img, camname, archived) {\n\tvar dbRec = {};\n\tdbRec.filename = img;\n\tdbRec.archive = (archived === true ? 1 : 0);\n\tdbRec.camname = camname;\n\tdbRec.account = User.accountid;\n\n\tvar dbReq = {};\n\tdbReq[img] = dbRec;\n\tDatabase.saveRecordParam(\"photos\", \"photos\", dbReq, function (dbResponse) {\n\t\t \n\t\tvar req = JSON.parse(dbResponse.usrmeta.order);\n\t\tvar key = Object.keys(req)[0];\n\t\tvar entry = req[key];\n\t\t\n\t\t// this here wont ever work update records returns 1 if the record has been inserted, save records param actually returns the last database insrted id, database needs cleaning \n\t\t//if (dbResponse.value === 0) {\n\t\t//\tSystem.status(\"Unable to favourite image '\" + entry.filename + \"'.\");\n\t\t//\treturn;\n\t\t//}\n\t\tcarouselPhotos[entry.filename].archive = entry.archive.toString();\n\t\tvar archived = (entry.archive === 1 ? true : false);\n\t\tset_archive(archived);\n\t});\n\t//set_archive(archived);\n\t//carouselPhotos[img][6] = (archived === true ? \"1\" : \"0\");\n}\n\nfunction download_image(img) {\n\tvar camname = img.camname.toUpperCase().replace(\" \", \"_\");\n\tvar filename = img.filename;\n\tvar vid_file = img.associated_video;\n  var element = document.createElement('a');\n\tif (video) {\n\t\tif (vid_file === \"\") {\n\t\t\treturn;\n\t\t}\n\t\telement.setAttribute('href', \"../userfiles/photo_processor/\" + img.account + \"/\" + camname + \"/\" + vid_file);\n\t} else {\n\t\telement.setAttribute('href', \"../userfiles/photo_processor/\" + img.account +  \"/\" + camname + \"/\" + filename + \".JPG\");\n\t}\n  element.setAttribute('download', filename);\n  element.style.display = 'none';\n  document.body.appendChild(element);\n  element.click();\n  document.body.removeChild(element);\n}\n\nfunction delete_image(img) {\n\tClient.invokeModal(\"OK\", \"Delete Image\", \"Are you sure you want to delete '\" + img + \"'?\", \"Delete\", \"DELETE\", function (buttonPressed) {\n\t\tif (buttonPressed === true) {\n\t\t\tvar dbRec = {};\n\t\t\tdbRec.filename = img;\n\t\t\tdbRec.deleted = 1;\n\t\t\tdbRec.camname = camname;\n\t\t\tdbRec.account = User.accountid;\n\t\t\tvar dbReq = {};\n\t\t\tdbReq[img] = dbRec;\n\t\t\tDatabase.updateRecord(\"photos\", \"photos\", dbReq, function (dbResponse) {\n \t\t\t\tvar req = JSON.parse(dbResponse.usrmeta.order);\n\t\t\t\tvar key = Object.keys(req)[0];\n\t\t\t\tvar entry = req[key];\n\t\t\t\tif (dbResponse.value === 0) {\n\t\t\t\t\tSystem.status(\"Unable to delete image '\" + entry.filename + \"'.\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t//carouselPhotos[entry.filename].deleted = entry.deleted.toString();\n\t\t\t\tget_carousel_images(camname);\n\t\t\t\t//ClientEvents.publish(\"thumb-remove\", carouselIndex);\n\t\t\t\t//delete carouselPhotos[entry.filename];\n\t\t\t\t//Client.status(\"Photo '\" + img + \"' deleted.\", \"IMPORTANT\");\n\t\t\t\t//carouselIndex--;\n\t\t\t\t//imageIndex--;\n\t\t\t\t//populate_fields(carouselPhotos[Object.keys(carouselPhotos)[imageIndex]]);\n\t\t\t});\n\t\t}\n\t});\n}\n\nfunction set_tags(tags) {\n\tClientEvents.publish(\"tags-receive\", tags);\n}\n\nfunction set_comments(comments) {\n\tClientEvents.publish(\"comments-receive\", comments);\n}\n\n/**\n * Initialise script state (run once at startup)\n */\nScript.on('load', function() {\n\t\n\tClientEvents.publish(\"video-receive\", \"camera-video\");\n\t\n\tClientEvents.subscribe(\"image-viewer-back-pressed\", function(event) {\n\t\tClient.jumpToScreen(\"Traps Phone\");\n\t});\n\t\n\tClientEvents.subscribe(\"image-viewer-start-date-change\", dateChange);\n\tClientEvents.subscribe(\"image-viewer-end-date-change\", dateChange);\n\t\n\t//File Index Change\n\tClientEvents.subscribe(\"file-index-change\", function(eventData, channel) {\n\t\tClient.clearDirtyFlag();\n\t\tvar index = parseInt(eventData.value) - 1;\n\t\tif (isNaN(index)) {\n\t\t\tconsole.error(\"index '\" + eventData.value + \"'could not be parsed to an integer\");\n\t\t\treturn;\n\t\t}\n\t\tif (index < 0) {\n\t\t\tconsole.error(\"index '\" + eventData.value + \"' is less than 0\");\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tClientEvents.publish(\"file-index-receive\", index+1);\n\t\t\n\t\tvar fileNames = Object.keys(carouselPhotos);\n\t\t// Clear all slides from carousel\n\t\tClientEvents.publish(\"thumb-clear\", \"\", false);\n\t\tloaded = [];\n\t\t\n\t\tvar j = 0;\n\t\tfor (var i = index - 15; i < index + 15; i++) {\n\t\t\tif (i < 0 || i > fileNames.length - 1) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (loaded.indexOf(fileNames[i]) !== -1) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (j < 15 && i < index) j++;\n\t\t\tvar cameraFolder = carouselPhotos[fileNames[i]].camname.toUpperCase().replace(\" \", \"_\");\n\t\t\tvar packet = {\n\t\t\t\tmethod: \"append\",\n\t\t\t\tsrc: \"../userfiles/photo_processor/\" + carouselPhotos[fileNames[i]].account + \"/\" + cameraFolder + \"/\" + carouselPhotos[fileNames[i]].filename + \"-thumb.JPG\",\n\t\t\t\tlabel: new Date(parseInt(carouselPhotos[fileNames[i]].datetime * 1000)).toLocaleString(\"en-AU\"),\n\t\t\t};\n\t\t\tClientEvents.publish(\"thumb-receive\", packet, false);\n\t\t\tloaded.push(fileNames[i]);\n\t\t}\n\t\timageIndex = index;\n\t\tpopulate_fields(carouselPhotos[fileNames[imageIndex]]);\n\t\tClientEvents.publish(\"thumb-goTo\", j, false);\n\t\t//carouselIndex = 15;\n\t});\n\t\n\t// Filter Selected\n\tClientEvents.subscribe(\"filter-selected\", function (eventData, channel) {\n\t\tvar camname = currentImage.camname;\n\t\tClientEvents.publish(\"image-viewer-start-date-receive\", \"\");\n\t\tClientEvents.publish(\"image-viewer-end-date-receive\", \"\");\n\t\tswitch (eventData.value.toUpperCase()) {\n\t\t\tcase \"FAVOURITE\":\n\t\t\t\tfilter = \"FAVOURITE\";\n\t\t\t\tget_carousel_images(camname, \"favourite=1\");\n\t\t\t\tbreak;\n\t\t\tcase \"ARCHIVED\":\n\t\t\t\tfilter = \"ARCHIVED\";\n\t\t\t\tget_carousel_images(camname, \"archive=1\");\n\t\t\t\tbreak;\n\t\t\tcase \"NOT VIEWED\":\n\t\t\t\tfilter = \"NOT VIEWED\";\n\t\t\t\tget_carousel_images(camname, \"viewed=0\");\n\t\t\t\tbreak;\n\t\t\tcase \"ALL\":\n\t\t\t\tfilter = \"ALL\";\n\t\t\t\tClientEvents.publish(\"filter-reset\");\n\t\t\t\tget_carousel_images(camname);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tconsole.error(\"unknown option\");\n\t\t\t\tbreak;\n\t\t}\n\t});\n\t\n\t// Clear Button Pressed\n\tClientEvents.subscribe(\"clear-pressed\", function (eventData, channel) {\n\t\tClientEvents.publish(\"tags-receive\", \"\");\n\t\tClientEvents.publish(\"comments-receive\", \"\");\n\t\tSystem.dirtyFlag(\"set\");\n\t});\n\t\n\t// Download Pressed\n\tClientEvents.subscribe(\"download-pressed\", function (eventData, channel) {\n\t\tdownload_image(currentImage);\n\t});\n\t\n\t// Favourite Pressed\n\tClientEvents.subscribe(\"favourite-pressed\", function (eventData, channel) {\n\t\t \n\t\tvar fav = (currentImage.favourite === \"1\" ? true : false );\n\t\tfavourite_image(currentImage.filename, !fav);\n\t});\n\t\n\t// Archive Pressed\n\tClientEvents.subscribe(\"archive-pressed\", function (eventData, channel) {\n\t\t \n\t\tvar archived = currentImage.archive;\n\t\tarchived = (archived === \"1\" ? true : false);\n\t\tarchive_image(currentImage.filename, currentImage.camname, !archived);\n\t});\n\t\n\t// Delete Pressed\n\tClientEvents.subscribe(\"delete-pressed\", function (eventData, channel) {\n\t\tdelete_image(currentImage.filename);\n\t});\n\t\n\t// Save Pressed\n\tClientEvents.subscribe(\"save-pressed\", function (eventData, channel) {\n\t\t\n\t\tvar formData = Script.getForm(\"image-tagging\");\n\t\tvar dbRec = {};\n\t\tdbRec.filename = currentImage.filename;\n\t\tdbRec.camname = camname;\n\t\tdbRec.account = User.accountid;\n\t\tdbRec.tags = formData[\"image-tags\"];\n\t\tdbRec.comments = formData[\"image-comments\"];\n\t\tvar dbReq = {};\n\t\tdbReq[currentImage.filename] = dbRec;\n\t\tDatabase.updateRecord(\"photos\", \"photos\", dbReq, function (dbResponse) {\n\t\t\t \n\t\t\tvar req = JSON.parse(dbResponse.usrmeta.order);\n\t\t\tvar key = Object.keys(req)[0];\n\t\t\tvar entry = req[key];\n\t\t\tif (dbResponse.value === 0) {\n\t\t\t\tSystem.status(\"Unable to save comments and tags for image '\" + entry.filename + \"'.\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tClient.clearDirtyFlag();\n\t\t\tcarouselPhotos[entry.filename].comments = entry.comments;\n\t\t\tcarouselPhotos[entry.filename].tags = entry.tags;\n\t\t});\n\t});\n\t\n\t// Refresh Pressed\n\tClientEvents.subscribe(\"refresh-pressed\", function (eventData, channel) {\n\t\tClientEvents.publish(\"table-clear\");\n\t\tget_table_entries();\n\t});\n\t\n\t// Table Pressed\n\tClientEvents.subscribe(\"table-pressed\", function (eventData, channel) {\n\t\t// Request entries for carousel\n\t\tClientEvents.publish(\"filter-reset\");\n\t\tvar key = Object.keys(eventData.value.data)[0];\n\t\tget_carousel_images(eventData.value.data[key][1]);\n\t});\n\t\n\t// Carousel Thumbnail Pressed\n\tClientEvents.subscribe(\"thumb-pressed\", function (eventData, channel) {\n\t\tvar filename = eventData.value.src.split(\"/\").pop().replace(\"-thumb.JPG\", \"\");\n\t\timageIndex = Object.keys(carouselPhotos).indexOf(filename);\n\t\tpopulate_fields(carouselPhotos[filename]);\n\t\tClientEvents.publish(\"file-index-receive\", imageIndex+1);\n\t});\n\t\n\t//Thumbnail Changed\n\tClientEvents.subscribe(\"thumb-changed\", function (eventData, channel) {\n\t\tif (eventData.value.method === \"goto\") {\n\t\t\treturn;\n\t\t}\n\t\tvar direction = (eventData.value.direction === \"right\" ? \"append\" : \"prepend\");\n\t\timageIndex += eventData.value.step;\n\t\t//if (eventData.value.method !== \"swipe\") {\n\t\t//\tcarouselIndex += event.value.step;\n\t\t//}\n\t\t\n\t\tvar fileNames = Object.keys(carouselPhotos);\n\t\tvar packet;\n\t\tfor (var i = imageIndex; i > imageIndex - 15; i--) {\n\t\t\tif (i < 0 || i > fileNames.length - 1) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (loaded.indexOf(fileNames[i]) !== -1) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tvar cameraFolder = carouselPhotos[fileNames[i]].camname.toUpperCase().replace(\" \", \"_\");\n\t\t\tpacket = {\n\t\t\t\tmethod: direction,\n\t\t\t\tsrc: \"../userfiles/photo_processor/\" + carouselPhotos[fileNames[i]].account + \"/\" + cameraFolder + \"/\" + carouselPhotos[fileNames[i]].filename + \"-thumb.JPG\",\n\t\t\t\tlabel: new Date(parseInt(carouselPhotos[fileNames[i]].datetime * 1000)).toLocaleString(\"en-AU\"),\n\t\t\t};\n\t\t\tClientEvents.publish(\"thumb-receive\", packet, false);\n\t\t\tloaded.push(fileNames[i]);\n\t\t\tcarouselIndex++;\n\t\t}\n\t\t\n\t\tfor (i = imageIndex; i < imageIndex + 15; i++) {\n\t\t\tif (i < 0 || i > fileNames.length -1) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (loaded.indexOf(fileNames[i]) !== -1) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tvar cameraFolder = carouselPhotos[fileNames[i]].camname.toUpperCase().replace(\" \", \"_\");\n\t\t\tpacket = {\n\t\t\t\tmethod: direction,\n\t\t\t\tsrc: \"../userfiles/photo_processor/\" +carouselPhotos[fileNames[i]].account + \"/\" + cameraFolder + \"/\" + carouselPhotos[fileNames[i]].filename + \"-thumb.JPG\",\n\t\t\t\tlabel: new Date(parseInt(carouselPhotos[fileNames[i]].datetime * 1000)).toLocaleString(\"en-AU\"),\n\t\t\t};\n\t\t\tClientEvents.publish(\"thumb-receive\", packet, false);\n\t\t\tloaded.push(fileNames[i]);\n\t\t}\n\t\tif (eventData.value.method !== \"swipe\") {\n\t\t\tClientEvents.publish(\"file-index-receive\", parseInt(imageIndex) + 1);\n\t\t\tpopulate_fields(carouselPhotos[fileNames[imageIndex]]);\n\t\t}\n\t});\n\t\n\t ClientEvents.subscribe(\"video-pressed\", function(eventData, channel) {\n\t\t var photo = currentImage;\n\t\t var cameraFolder = photo.camname.toUpperCase().replace(\" \", \"_\");\n\t\t if (video) {\n\t\t\t video = !video;\n\t\t\t ClientEvents.publish(\"video-receive\", \"camera-video\");\n\t\t\t ClientEvents.publish(\"iamge-set\", \"../userfiles/photo_processor/\" + photo.account + \"/\" + cameraFolder + \"/\" + photo.filename + \"-preview.JPG\");\n\t\t } else {\n\t\t\t video = !video;\n\t\t\t ClientEvents.publish(\"video-receive\", \"camera-video-fill\");\n\t\t\t set_video(photo);\n\t\t }\n\t });\n\t\n\t// ImageViewer Next\n\tClientEvents.subscribe(\"next-pressed\", function(eventData, channel) {\n\t\t//imageIndex++;\n\t\t//populate_fields(carouselPhotos[Object.keys(carouselPhotos)[imageIndex]]);\n\t\tClientEvents.publish(\"thumb-next\");\n\t});\n\t\n\t// ImageViewer Previous\n\tClientEvents.subscribe(\"previous-pressed\", function(eventData, channel) {\n\t\t//imageIndex--;\n\t\t//populate_fields(carouselPhotos[Object.keys(carouselPhotos)[imageIndex]]);\n\t\tClientEvents.publish(\"thumb-previous\");\n\t});\n\t\n\tClientEvents.subscribe(\"date-filter-reset-pressed\", function(eventData, channel) {\n\t\tClientEvents.publish(\"image-viewer-end-date-receive\", \"\");\n\t\tClientEvents.publish(\"image-viewer-start-date-receive\", new Date().toISOString().split(\"T\")[0]);\n\t\tdateChange();\n\t});\n\t\n\t// Request data for carousel\n\tClientEvents.publish(\"image-viewer-start-date-receive\", new Date().toISOString().split(\"T\")[0]);\n\tcamname = Script.getState(\"camera_name\");\n\tif (camname) {\n\t\tClientEvents.publish(\"image-viewer-camera-name-receive\", camname);\n\t\tcamname = camname.toLowerCase();\n\t\tget_carousel_images(camname);\n\t}\n\t\n\tScript.subscribeToChannel(\n\t\t\"IMAGE_VIEWER_TRAP_SUBURB\",\n\t\t{\n\t\t\tcategory: User.accountid.toUpperCase(),\n\t\t\tclassName: \"trail4g\",\n\t\t\tscope: \"suburb\"\n\t\t}, function(e) {\n\t\t});\n});\n\n/**\n * Response to message from server channel\n */\nScript.on('server', function(eventData, channel) {\n});"},"ev":{"serverEvents":{"inputEvents":{"New Event #1":{"channel":"$DB/ADMIN/MANAGE/RESPONSE","event":"feed","important":"false"}}}}},"cameraTable":{"t":"Scripting","lX":265,"lY":345,"sX":1,"sY":1,"s":"Camera Table","ps":{"enabled":"false","scalingType":"NOSCALE","width":"","height":"","x":"","y":""},"ver":"200124c190915","vis":false,"dis":false,"tt":"","a":{"script type":"javascript","code editor":"//# sourceURL=camera-table-script.js\n/**\n * Description: \n * Create Author/Date: \n * Modified Author/Date Date: \n * Version: \n */\n\n/**\n * Initialise script state (run once at startup)\n */\n\nvar dataCollection = new SensaCollection(\n\t[\n\t\t\"thumbnail\",\n\t\t\"camera name\",\n\t\t\"datetime\",\n\t\t\"viewed\",\n\t\t\"battery\",\n\t\t\"signal\"\n\t],\n\t\"camera name\"\n);\nfunction get_table() {\n\tDatabase.readRecords(\n\t\t\"photos\",\n\t\t\"photos\",\n\t\tfunction (dbResponse) {\n\t\t\tvar key = Object.keys(dbResponse.value.data)[0];\n\t\t\tvar camName = String(dbResponse.value.data[key][1]);\n\t\t\tpopulate(dbResponse.value);\n\t\t},\n\t\t{\n\t\t\tcolumns: \"filename,camname,datetime,viewed,account\",\n\t\t\tfilter: \"deleted=0 AND account=\" + User.accountid,\n\t\t\torder: \"GROUP BY camname HAVING datetime=MAX(datetime) ORDER BY datetime DESC\",\n\t\t}\n\t);\n}\n\nfunction populate(value){\n\tvar collection = new SensaCollection(\n\t\t[\n\t\t\t\"thumbnail\",\n\t\t\t\"camera name\",\n\t\t\t\"datetime\",\n\t\t\t\"viewed\"\n\t\t],\n\t\t\"camera name\"\n\t);\n\t// add thumbnail column to headers\n\tvalue.headers.unshift(\"thumbnail\");\n\tvar index = value.headers.indexOf(\"camname\");\n\tif (index === -1) {\n\t\treturn;\n\t}\n\tvalue.headers[index] = \"camera name\";\n\tvalue.pk = \"camera name\";\n\t\n\t// rebuild data packet\n\tObject.keys(value.data).forEach(function (item) {\n\t\t// convert from Unix time\n\t\tvalue.data[item][2] = new Date(parseInt(value.data[item][2] * 1000)).toLocaleString(\"en-AU\");\n\t\t// Create thumbnail\n\t\tvar img = new Image();\n\t\timg.style.setProperty(\"width\", \"100%\");\n\t\timg.style.setProperty(\"height\", \"auto\");\n\t\timg.src = \"../userfiles/photo_processor/\" + value.data[item][4] + \"/\" + value.data[item][1].toUpperCase().replace(\" \", \"_\") + \"/\" + item.split(\".\")[0] +\"-thumb.JPG\";\n\t\t\n\t\t//value.data[item][1] = value.data[item][1].toUpperCase();\n\t\t\n\t\tvalue.data[item].unshift(img.outerHTML);\n\t\t// Create viewed icon\n\t\tvar viewedImg = new Image();\n\t\tviewedImg.style.setProperty(\"width\", \"35%\");\n\t\tviewedImg.style.setProperty(\"height\", \"auto\");\n\t\tviewedImg.style.setProperty(\"margin-left\", \"calc(50% - 17.5%)\");\n\t\tif (value.data[item][4] === \"0\") {\n\t\t\tviewedImg.src = \"../images/icons/bootstrap/eye-fill.svg\";\n\t\t} else {\n\t\t\tviewedImg.src = \"../images/icons/bootstrap/eye.svg\";\n\t\t}\n\t\tvalue.data[item][4] = viewedImg.outerHTML;\n\t\t\n\t\t/*// Create favourite image\n\t\tvar favImg = new Image();\n\t\tfavImg.style.setProperty(\"width\", \"35%\");\n\t\tfavImg.style.setProperty(\"height\", \"auto\");\n\t\tfavImg.style.setProperty(\"margin-left\", \"calc(50% - 17.5%)\");\n\t\tif (value.data[item][5] === \"1\") {\n\t\t\tfavImg.src = \"../images/icons/bootstrap/star-fill.svg\";\n\t\t} else {\n\t\t\tfavImg.src = \"../images/icons/bootstrap/star.svg\";\n\t\t}\n\t\tvalue.data[item][5] = favImg.outerHTML;\n\t\t*/\n\t\tvalue.data[item].splice(1, 1);\n\t\tvalue.data[item][1] = value.data[item][1].toLowerCase();\n\t\tvar dataObj = {\n\t\t\t\"thumbnail\" : value.data[item][0],\n\t\t\t\"camera name\": value.data[item][1],\n\t\t\t\"datetime\": value.data[item][2],\n\t\t\t\"viewed\": value.data[item][3]\n\t\t};\n\t\tcollection.add(dataObj);\n\t});\n\tdataCollection = dataCollection.merge(collection);\n\tClientEvents.publish(\"camera-table-receive\", dataCollection, false);\n}\n\nScript.on('load', function() {\n\t\n\t// Clear table\n\tClientEvents.publish(\"camera-table-clear\");\n\t\n\tClientEvents.subscribe(\"camera-table-refresh-pressed\", function (eventData, channel) {\n\t\tget_table();\n\t});\n\t\n\tClientEvents.subscribe(\"camera-table-pressed\", function (eventData, channel) {\n\t\tvar key = Object.keys(eventData.value.data)[0];\n\t\tScript.setState(\"camera_name\", eventData.value.data[key][1]);\n\t\tClient.jumpToScreen(\"Image Viewer\");\n\t});\n\tget_table();\n});\n\nScript.on(\"server\", function(e, c) {\n\tvar value = null;\n\tif (e.value instanceof SensaCollection) {\n\t\tvalue = e.value;\n\t} else if (typeof e.value === \"string\") {\n\t\tvalue = JSON.parse(e.value);\n\t} else if (value == null) {\n\t\treturn;\n\t}\n\tswitch(c.split(\"/\")[0]) {\n\t\tcase User.accountid.toUpperCase():\n\t\t\tif (!Array.isArray(value.headers)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvar pkIndex = value.headers.indexOf(\"instance\");\n\t\t\tif (pkIndex === -1) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvalue.headers[pkIndex] = \"camera name\";\n\t\t\t\n\t\t\tvalue.headers = value.headers.map(function (item) {return item.toLowerCase();});\n\t\t\tvar collection = SensaCollection.prototype.load(value);\n\t\t\t\n\t\t\tcollection = collection.filter([\"camera name\", \"battery\", \"signal\"]);\n\t\t\tcollection.pk = \"camera name\";\n\t\t\tcollection.forEach(function(item, key) {\n\t\t\t\titem[\"camera name\"] = item[\"camera name\"].toLowerCase();\n\t\t\t\t//item.battery = item.battery && (item.battery !== \"\") ? item.battery += \"%\" : \"-\";\n\t\t\t\t//item.signal = item.signal && (item.signal !== \"\") ? item.signal += \"%\" : \"-\";\n\t\t\t\tcollection.add(item);\n\t\t\t\tcollection.remove(key);\n\t\t\t});\n\t\t\tdataCollection = dataCollection.merge(collection);\n\t\t\tClientEvents.publish(\"camera-table-receive\", dataCollection, false);\n\t\t\tbreak;\n\t\t\t\n\t}\n});"},"ev":{"serverEvents":{"inputEvents":{"Trail Camera Data":{"channel":"[accountid]/TRAIL4G/+/+","event":"feed","important":"false"}}}}},"Label#1":{"t":"Label","lX":17,"lY":15,"sX":17.43,"sY":2.76,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"100%","height":"7.81%","x":"1%","y":"15px"},"ver":"200124c190915","dis":false,"tt":"","a":{"font size":"14","label text":"<b>Camera Name: </b>[#]<br>"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"image-viewer-camera-name-receive/receive value","event":"receive value","important":"false"}}}}},"Button#1":{"t":"Button","lX":27,"lY":1439,"sX":0.8,"sY":1.09,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"80px","height":"50px","x":"2%","y":"225%"},"ver":"190104c190915","dis":false,"tt":"","a":{"button name":"Back","color":"orange strong"},"ev":{"clientEvents":{"outputEvents":{"New Event #1":{"channel":"image-viewer-back-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"Maps#1":{"t":"Maps","lX":0,"lY":1107,"sX":3.49,"sY":0.88,"s":"Image Viewer","ps":{"enabled":"true","scalingType":"OK","width":"100%","height":"50%","x":"0%","y":"170%"},"ver":"190104c190915","dis":false,"tt":"","a":{},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"image-viewer-map-receive/receive value","event":"receive value","important":"false"},"Set Map":{"channel":"image-viewer-set-map/set map","event":"set map","important":"false"},"Clear":{"channel":"image-viewer-map-clear/clear map","event":"clear map","important":"false"},"Set Zoom":{"channel":"image-viewer-map-set-zoom/set zoom","event":"set zoom","important":"false"}}}}}},"screens":{"Traps Phone":{"index":0,"icon":"widgets","meta":""},"Map":{"index":1,"icon":"widgets","meta":""},"Image Viewer":{"index":2,"icon":"widgets","meta":""},"Camera Table":{"index":3,"icon":"widgets","meta":""}},"meta":""}
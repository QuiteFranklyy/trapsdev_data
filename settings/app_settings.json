{"device":"DESKTOP","widgets":{"Icon#11":{"t":"Icon","lX":315,"lY":665,"sX":0.7,"sY":0.7,"s":"Lookups","ps":{"enabled":false,"scalingType":"NOHORIZ,NOVERT","width":"2.03%","height":"4.05%","x":"10.71%","y":"82.43%"},"ver":"200628c190915","dis":false,"tt":"","a":{"outline color":"no outline","icon file":"trash","color":"red"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"lookup-delete-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"lookup-value":{"t":"Input","lX":20,"lY":650,"sX":2.6,"sY":1,"s":"Lookups","ps":{"enabled":false,"scalingType":"NOVERT","width":"15.06%","height":"4.41%","x":"1.16%","y":"75.34%"},"ver":"270520c190915","dis":false,"tt":"","a":{"bold":"true","label text":"Value","form id":"lookup-form","color":"grey"},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"lookup-value-receive/receive value","event":"receive value","important":"false"}}}}},"lookup-dropdown":{"t":"Dropdown","lX":15,"lY":70,"sX":3.25,"sY":1,"s":"Lookups","ps":{"enabled":false,"scalingType":"NOVERT","width":"18.82%","height":"5.72%","x":"0.63%","y":"5.66%"},"ver":"190104c190915","dis":false,"tt":"","a":{"label text":"Lookup Table","bold":"true","form id":"lookup-form","default options":""},"ev":{"clientEvents":{"inputEvents":{"Receive":{"channel":"lookup-dropdown-receive-list/receive list","event":"receive list","important":"false"}},"outputEvents":{"Selected":{"channel":"lookup-dropdown-selected/receive value","event":"selected","trigger":"selected","important":"false"}}}}},"lookup-clear":{"t":"Icon","lX":240,"lY":670,"sX":0.7,"sY":0.7,"s":"Lookups","ps":{"enabled":false,"scalingType":"NOHORIZ,NOVERT","width":"2.03%","height":"2.91%","x":"14.01%","y":"77.92%"},"ver":"200628c190915","dis":false,"tt":"","a":{"outline color":"no outline","icon file":"x","color":"black"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"lookup-clear-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"lookup-save":{"t":"Icon","lX":280,"lY":665,"sX":0.7,"sY":0.7,"s":"Lookups","ps":{"enabled":false,"scalingType":"NOHORIZ,NOVERT","width":"2.03%","height":"4.05%","x":"1.51%","y":"82.77%"},"ver":"200628c190915","dis":false,"tt":"","a":{"outline color":"no outline"},"ev":{"clientEvents":{"outputEvents":{"Pressed":{"channel":"lookup-save-pressed/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"lookup-table":{"t":"Table","lX":20,"lY":135,"sX":3.2,"sY":5,"s":"Lookups","ps":{"enabled":false,"scalingType":"OK","width":"18.53%","height":"57.21%","x":"0.93%","y":"10.92%"},"ver":"190104c190915","dis":false,"tt":"","a":{"columns":"value","selectable":"single","text color":"#000000","row color":"#000000","form id":"lookup-form","display column titles":"false","colWidths":""},"ev":{"clientEvents":{"inputEvents":{"Clear":{"channel":"lookup-table-clear/delete all rows","event":"delete all rows","important":"false"},"Set Title":{"channel":"lookup-table-set-title/set title","event":"set title","important":"false"},"Receive":{"channel":"lookup-table-receive/receive value","event":"receive value","important":"false"}},"outputEvents":{"Pressed":{"channel":"lookup-table-selected/receive value","event":"pressed","trigger":"pressed","important":"false"}}}}},"LookupsController":{"t":"Scripting","lX":460,"lY":290,"sX":1,"sY":1,"s":"Lookups","ps":{"enabled":false,"scalingType":"NOSCALE","width":"16.92%","height":"15.02%","x":"0%","y":"0%"},"ver":"200124c190915","vis":false,"dis":false,"tt":"","a":{"script type":"javascript","code editor":"/**\n * Description: \n * Create Author/Date: \n * Modified Author/Date Date: \n * Version: \n */\n var oldVal;\n\n // Get list of tables in lookups DB\n function get_lookup_keys() {\n     Database.readRecords(\n         \"traps\",\n         \"lookups\",\n         function (dbResponse) {\n             if (dbResponse.value === 0) {\n                 return;\n             }\n             var keys = Object.keys(dbResponse.value.data);\n             ClientEvents.publish(\"lookup-dropdown-receive-list\", keys, false);\n             get_option_values(keys[0]);\n         },\n         {\n             columns: \"DISTINCT key\",\n             filter: \"\",\n             order: \"\"\n         }\n     );\n }\n \n function get_option_values(option) {\n     \n     option = option.toLowerCase();\n     var compoundQuery = [\n         {\n             \"TableName\" : \"lookups\", // Specify the primary table used to construct the join request\n             \"Columns\" :\n             [\n                 \"key\",\n                 \"value\",\n             ]\n          }];\n     Database.readComposite(\"traps\",\"lookups\", compoundQuery,  [\n         {\n                 \"Column\": \"key\",\n                 \"Value\": option\n         }\n     ], function(dbResponse) {\n           \n         ClientEvents.publish(\"lookup-table-clear\", \"\", false);\n         var collection = new SensaCollection([option,\"value\"], option);\n         Object.keys(dbResponse.value.data).forEach( function (key) {\n             var value = dbResponse.value.data[key][0];\n             var obj = {};\n             obj[\"value\"] = value;\n             obj[option] = key;\n             collection.add(obj);\n         });\n         ClientEvents.publish(\"lookup-table-receive\", collection, false);\n     });\n }\n         \n \n \n function get_dropdown_value () {\n     var formData = Script.getForm(\"lookup-form\");\n     var option = formData[\"lookup-dropdown\"];\n     if (typeof option !== \"string\" && !(option instanceof String)) {\n         option = \"\";\n     }\n     return option;\n }\n \n /**\n  * Initialise script state (run once at startup)\n  */\n Script.on('load', function() {\n     \n     // Load lookups database;\n     get_lookup_keys();\n     //create_dummy_data();\n     \n     ClientEvents.subscribe(\"lookup-dropdown-selected\", function (eventData, channel) {\n         get_option_values(eventData.value);\n     });\n     \n     //Get value is lookup-dropdown and set title of Table\n     var option = get_dropdown_value();\n     if (option) {\n         ClientEvents.publish(\"lookup-table-set-title\", option);\n         Database.readRecords(\"lookup\", option.toLowerCase(), \"*\", \"\", \"ORDER by key COLLATE NOCASE ASC\");\n     }\n     \n     ClientEvents.subscribe(\"lookup-table-selected\", function(eventData, channel) {\n          \n         Object.keys(eventData.value.data).forEach(function (item, index, array) {\n             if (array.length !== 1) {\n                 throw new Error(\"Array should be of length 1 when table is selected \" + String.fromCodePoint(0x1F641));\n             }\n             \n             oldVal = eventData.value.data[item][1];\n             ClientEvents.publish(\"lookup-value-receive\",  eventData.value.data[item][1]);\n         });\n     });\n     \n     ClientEvents.subscribe(\"lookup-clear-pressed\", function(eventData, channel) {\n         ClientEvents.publish(\"lookup-value-receive\", \"\");\n     });\n     \n     ClientEvents.subscribe(\"lookup-save-pressed\", function(eventData, channel) {\n             \n         var option = get_dropdown_value().toLowerCase();\n         if (option === \"\") {\n             console.error(\"Unable to get dropdown option \" + String.fromCodePoint(0x1F641));\n             return false;\n         }\n         var formData = Script.getForm(\"lookup-form\");\n         if (formData.constructor !== Object) {\n             console.error(\"Unable to get for data from form \" + String.fromCodePoint(0x1F641));\n             return false;\n         }\n         var value = formData[\"lookup-value\"];\n         if (typeof value !== \"string\" && !(key instanceof String)) {\n             console.error(\"Value is not a string \" + String.fromCodePoint(0x1F641));\n             return false;\n         }\n         if (value === \"\") {\n             return;\n         }\n         \n         var packet = {};\n          \n  \n         packet = \n         [\n             {\n                 \"TableName\":\"lookups\",\n                 \"OnConflict\":\n                 [\n                     {\n                         \"Column\":\"key\",\n                         \"ParamName\":\"conf1\",\n                         \"Value\":option\n                     },\n                     {\n                         \"Column\":\"value\",\n                         \"ParamName\":\"conf2\",\n                         \"Value\":value\n                     }\n                 ],\n                 \"data\":\n                 [\n                     {\n                         \"Column\":\"key\",\n                         \"ParamName\":\"option1\",\n                         \"value\":option\n                     },\n                     {\n                         \"Column\":\"value\",\n                         \"ParamName\":\"val1\",\n                         \"value\":oldVal\n                     }\n                 ],\n                 \"Filters\":\n                 [\n                     {\n                         \"Column\":\"key\",\n                         \"ParamName\":\"option1\",\n                         \"value\":option\n                     },\n                     {\n                         \"Column\":\"value\",\n                         \"ParamName\":\"val1\",\n                         \"value\":oldVal\n                     }\n                 ]\n             }\n         ];\n         \n         Database.saveComposite(\n             \"traps\",\n             \"lookups\",\n             packet,\n             function (dbResponse) {\n                 oldVal = undefined;\n \n                 //this can be simplified not to run a query each time a record has been added or edited but rather to edit the clicked record to save load on the database instnace per action\n                 get_option_values(option);\n             }\n         );\n     });\n     \n     ClientEvents.subscribe(\"lookup-delete-pressed\", function(eventData, channel) {\n          \n          var option = get_dropdown_value();\n         if (option === \"\") {\n             console.error(String.fromCodePoint(0x1F641));\n             return false;\n         }\n         var formData = Script.getForm(\"lookup-form\");\n         if (formData[\"lookup-table\"] === undefined) {\n             console.error(String.fromCodePoint(0x1F641));\n             return false;\n         }\n         var data;\n         var obj = formData[\"lookup-table\"];\n         if (obj.data !== undefined && Object.prototype.toString.call(obj.data) === \"[object Object]\") {\n             data = obj.data;\n         }\n          \n         var val = first(data);\n         // Kris to check because this is his script now.\n         if (val === undefined) {\n             return;\n         }\n         \n         var compoundQeury = [\n         {\n             \"TableName\" : \"lookups\", // Specify the primary table used to construct the join request\n \n             \"Filters\" : // Filter options in case they are needed.\n             [\n                 {\n                     \"Column\":\"key\",\n                     \"ParamName\":\"key\",\n                     \"Value\":option.toLowerCase() // Query issue was that the key is set to be an upper case in the dropdown but the actual value in the databse is lowercase.\n                 },\n                 {\n                     \"Column\":\"value\",\n                     \"ParamName\":\"value\",\n                     \"Value\":val[1]\n                 },\n \n             ],\n \n         }];\n \n         Database.deleteRecordParam(\"traps\", \"lookups\",compoundQeury, function(data){\n             \n             if(data.value === 1)\n             {\n                 \n                 oldVal = undefined;\n \n                 Client.clearDirtyFlag();\n                 get_option_values(option);\n \n             }\n         });\n \n         Object.keys(data).forEach(function (value, index, array) {\n             ClientEvents.publish(\"lookup-value-receive\", \"\");\n         });\n     });\n \n });\n function first(p) {\n   for (var i in p) return p[i];\n }\n /**\n  * Response to message from server channel\n  */\n Script.on('server', function(eventData) {\n });","import file":"true","file name":"lookupController.js","subscribe to directory":"true","subscribe to database":"true"},"ev":{"serverEvents":{"inputEvents":{"New Event #1":{"channel":"$DB/ADMIN/MANAGE/RESPONSE","event":"feed","important":"false"}}}}},"LookUpManager":{"t":"Container","lX":0,"lY":15,"sX":3.7,"sY":7.4,"s":"Lookups","ps":{"enabled":false,"scalingType":"OK","width":"21.42%","height":"84.67%","x":"0%","y":"0%"},"ver":"190104c190915","z":"110","dis":false,"tt":"","a":{"color":"grey","title":"Manage Lookup Data"},"ev":{}},"Container#9":{"t":"Container","lX":150,"lY":50,"sX":7.35,"sY":1.95,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"OK","width":"16.58%","height":"29.04%","x":"6.29%","y":"4.02%"},"ver":"190104c210519","z":"100","dis":false,"tt":"","a":{"title":"Title"},"ev":{}},"Dropdown#2":{"t":"Dropdown","lX":295,"lY":80,"sX":1.9,"sY":1,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"NOVERT","width":"7.97%","height":"4.02%","x":"12.38%","y":"6.43%"},"ver":"190104c210519","dis":false,"tt":"","a":{"default value":"tilt","default options":"off, tilt, field, tas_tilt","form id":"mqtt","form key":"set"},"ev":{}},"Dropdown#3":{"t":"Dropdown","lX":295,"lY":150,"sX":1.9,"sY":1,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"NOVERT","width":"7.97%","height":"4.02%","x":"12.38%","y":"6.43%"},"ver":"190104c210519","z":"100","dis":false,"tt":"","a":{"default value":"off","default options":"off,set,triggered,set_triggered","form id":"mqtt","form key":"state"},"ev":{}},"Scripting#1":{"t":"Scripting","lX":255,"lY":285,"sX":1,"sY":1,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"OK","width":"9.08%","height":"8.1%","x":"23.25%","y":"23.01%"},"ver":"200124c210519","dis":false,"tt":"","a":{"script type":"javascript","code editor":"/**\n * Initialise script state (run once at startup)\n */\n\nScript.on('load', async function() {\n\tlet setBtn = Script.getWidget(\"setBtn\");\n\tlet stateBtn = Script.getWidget(\"stateBtn\");\n\t\n\tsetBtn.subscribe(\"pressed\", function() {\n\t\tlet form = Script.getFormByKey(\"mqtt\");\n\t\tconst setValue = form.set;\n\t\tconst packet = {\n\t\t\tcategory: \"ATS\",\n\t\t\tclassName: \"ATS\",\n\t\t\tinstance: \"ATS\",\n\t\t\tscope: \"MODE\",\n\t\t\tvalue: JSON.stringify(form)\n\t\t};\n\t\t\n\t\tScript.publishToChannel(packet);\n\t});\n\t\n\tstateBtn.subscribe(\"pressed\", function() {\n\t\tlet form = Script.getFormByKey(\"mqtt\");\n\t\tconst setValue = form.state;\n\t\tconst packet = {\n\t\t\tcategory: \"ATS\",\n\t\t\tclassName: \"ATS\",\n\t\t\tinstance: \"ATS\",\n\t\t\tscope: \"STATE\",\n\t\t\tvalue: JSON.stringify(form)\n\t\t};\n\t\t\n\t\tScript.publishToChannel(packet);\n\t\t\n\t\tconst packet2 = {\n\t\t\tcategory: \"$NET\",\n\t\t\tclassName: \"TWILIO\",\n\t\t\tinstance: \"SEND\",\n\t\t\tscope: \"SMS\",\n\t\t\tvalue: JSON.stringify({\n\t\t\t\tto: [\"+61421843800\", \"+61421843800\"],\n\t\t\t\tbody: \"Send from Sensahub\"\n\t\t\t})\n\t\t};\n\t\t\n\t\tScript.publishToChannel(packet2);\n\t\tconsole.log(\"SMS sent\");\n\t});\n});"},"ev":{}},"setBtn":{"t":"Button","lX":175,"lY":95,"sX":1,"sY":1,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"OK","width":"4.2%","height":"3.8%","x":"6.29%","y":"7.64%"},"ver":"190104c210519","dis":false,"tt":"","a":{"button name":"Mode"},"ev":{}},"stateBtn":{"t":"Button","lX":175,"lY":155,"sX":1,"sY":1,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"OK","width":"4.2%","height":"3.8%","x":"6.29%","y":"7.64%"},"ver":"190104c210519","z":"100","dis":false,"tt":"","a":{"button name":"State"},"ev":{}},"Label#6":{"t":"Label","lX":520,"lY":175,"sX":2.1,"sY":1,"s":"ATS Test panel","ps":{"enabled":"false","scalingType":"OK","width":"15.45%","height":"2.01%","x":"38.34%","y":"26.05%"},"ver":"200124c210519","dis":false,"tt":"","a":{"font size":"14","label text":"State:&nbsp;[#]"},"ev":{"serverEvents":{"inputEvents":{"New Event #1":{"channel":"ATS/ATS/ATS/OTHER","event":"feed","important":"false"}}}}}},"screens":{"Lookups":{"index":0,"icon":"widgets","meta":""},"ATS Test panel":{"index":1,"icon":"widgets","meta":""}},"meta":""}